<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SalonBooking DApp üíà</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: "Inter", sans-serif;
      background-color: #0d1117;
      color: #e6edf3;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    h1 {
      color: #e6edf3;
      font-size: 26px;
      text-align: center;
      margin-bottom: 5px;
    }

    p {
      text-align: center;
      color: #8b949e;
      font-size: 15px;
    }

    input, button {
      font-size: 15px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
    }

    input {
      background-color: #161b22;
      color: #e6edf3;
    }

    button {
      cursor: pointer;
      transition: 0.2s;
    }

    #connectButton {
      background-color: #238636;
      color: white;
      max-width: 500px;
    }

    #bookButton {
      background-color: #2ea043;
      color: white;
    }

    #myBookingsButton {
      background-color: #1f6feb;
      color: white;
    }

    #status {
      margin-top: 10px;
      color: #f85149;
      text-align: center;
      white-space: pre-line;
      font-size: 14px;
    }

    #bookingsList {
      margin-top: 25px;
      padding: 10px;
      background-color: #161b22;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
    }

    .booking {
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #30363d;
    }

    .booking:last-child {
      border-bottom: none;
    }

    .booking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
    }

    .badge.future {
      background-color: #1f6feb33;
      color: #58a6ff;
    }

    .badge.done {
      background-color: #2ea04333;
      color: #3fb950;
    }

    .badge.cancelled {
      background-color: #f8514933;
      color: #f85149;
    }

    .cancel-btn {
      background-color: #f85149;
      color: white;
      font-size: 13px;
      padding: 6px 10px;
      width: auto;
      border-radius: 999px;
    }

    footer {
      margin-top: 30px;
      font-size: 13px;
      color: #8b949e;
      text-align: center;
    }

    .fee-note {
      color: #58a6ff;
      font-size: 14px;
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>SalonBooking DApp üíà</h1>
  <p>Connetti MetaMask su Polygon, scegli data/ora e importo (in MATIC), e invia una prenotazione on-chain.</p>

  <button id="connectButton">Connetti Wallet</button>

  <div style="max-width:500px; width:100%; margin-top:20px;">
    <label>Data e ora (locale)</label>
    <input id="datetime" type="datetime-local">

    <label>Importo (MATIC)</label>
    <input id="amount" type="number" step="0.001" placeholder="0.01">

    <button id="bookButton">Prenota ora üíà</button>
    <button id="myBookingsButton">Le mie prenotazioni</button>

    <div class="fee-note">üí∞ Fee del 3% a favore della piattaforma su ogni prenotazione e cancellazione.</div>

    <div id="status"></div>
    <div id="bookingsList"></div>
  </div>

  <footer>¬© 2025 Sebastian Muscillo ‚Äî Blockchain Parrucchiere üíà</footer>

  <script>
    const CONTRACT_ADDRESS = "0x1317e9dc0eae1f3ef84f1157951d5629e699bc54"; // Proxy su Polygon

    // ABI minimale per V3: book, cancelBooking, lettura prenotazioni, feeBps
    const ABI = [
      "function book(uint256 when, string note) payable returns (uint256)",
      "function cancelBooking(uint256 id)",
      "function bookings(uint256 id) view returns (address user, uint256 when, uint256 amount, bool cancelled)",
      "function bookingsOf(address user) view returns (uint256[] memory)",
      "function feeBps() view returns (uint256)"
    ];

    let provider, signer, contract;

    const connectButton = document.getElementById("connectButton");
    const bookButton = document.getElementById("bookButton");
    const myBookingsButton = document.getElementById("myBookingsButton");
    const statusDiv = document.getElementById("status");
    const listDiv = document.getElementById("bookingsList");

    function setStatus(msg, type = "info") {
      statusDiv.textContent = msg;
      if (type === "error") statusDiv.style.color = "#f85149";
      else if (type === "success") statusDiv.style.color = "#3fb950";
      else statusDiv.style.color = "#8b949e";
    }

    // Connetti wallet + mostra feeBps dinamica
    connectButton.onclick = async () => {
      try {
        if (!window.ethereum) return alert("Installa MetaMask!");

        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

        const addr = await signer.getAddress();
        connectButton.textContent = addr.slice(0, 6) + "..." + addr.slice(-4);
        connectButton.disabled = true;

        const fee = await contract.feeBps();
        document.querySelector(".fee-note").textContent =
          `üí∞ Fee attuale: ${(Number(fee) / 100).toFixed(2)}% a favore della piattaforma su ogni prenotazione e cancellazione.`;

        setStatus("Wallet connesso.", "success");
      } catch (err) {
        console.error(err);
        setStatus("Errore connessione wallet.", "error");
      }
    };

    // Prenotazione
    bookButton.onclick = async () => {
      try {
        if (!contract) return alert("Connetti prima MetaMask!");

        const dtValue = document.getElementById("datetime").value;
        const when = Math.floor(new Date(dtValue).getTime() / 1000);
        const amount = document.getElementById("amount").value;

        if (!when || isNaN(when)) {
          return setStatus("Inserisci una data valida.", "error");
        }
        if (when < Date.now() / 1000 + 600) {
          return setStatus("La data deve essere almeno 10 minuti nel futuro.", "error");
        }
        if (!amount || Number(amount) <= 0) {
          return setStatus("Inserisci un importo maggiore di 0.", "error");
        }

        setStatus("‚è≥ Invio prenotazione...");
        const tx = await contract.book(when, "prenotazione on-chain", {
          value: ethers.parseEther(amount.toString())
        });

        await tx.wait();
        setStatus("‚úÖ Prenotazione inviata con successo!", "success");
      } catch (err) {
        console.error(err);
        setStatus("‚ùå Errore nella prenotazione: " + (err.info?.error?.message || err.message || err), "error");
      }
    };

    // Carica le prenotazioni dell'utente
    myBookingsButton.onclick = async () => {
      try {
        if (!contract) return alert("Connetti prima MetaMask!");
        setStatus("üì¶ Caricamento prenotazioni...");
        listDiv.innerHTML = "";

        const addr = await signer.getAddress();
        const ids = await contract.bookingsOf(addr);

        if (ids.length === 0) {
          setStatus("Nessuna prenotazione trovata.");
          return;
        }

        const nowSec = Math.floor(Date.now() / 1000);

        for (let i = 0; i < ids.length; i++) {
          const id = ids[i];
          const b = await contract.bookings(id);
          const dateStr = new Date(Number(b.when) * 1000).toLocaleString();
          const netMatic = (Number(b.amount) / 1e18).toFixed(3);

          let badgeClass = "future";
          let statoLabel = "Futura";
          if (b.cancelled) {
            badgeClass = "cancelled";
            statoLabel = "Cancellata";
          } else if (Number(b.when) <= nowSec) {
            badgeClass = "done";
            statoLabel = "Completata/Passata";
          }

          const canCancel = !b.cancelled && Number(b.when) > nowSec;

          const div = document.createElement("div");
          div.className = "booking";
          div.innerHTML = `
            <div class="booking-header">
              <div>
                <strong>#${Number(id)}</strong> ‚Äì ${dateStr}
                <span class="badge ${badgeClass}">${statoLabel}</span>
              </div>
              ${canCancel ? `<button class="cancel-btn" data-id="${Number(id)}">Cancella</button>` : ""}
            </div>
            <div>Importo netto on-chain: ${netMatic} MATIC</div>
          `;
          listDiv.appendChild(div);
        }

        setStatus("Prenotazioni aggiornate.");
      } catch (err) {
        console.error(err);
        setStatus("Errore nel caricamento delle prenotazioni.", "error");
      }
    };

    // Gestione click sul pulsante "Cancella" (event delegation)
    listDiv.onclick = async (event) => {
      const btn = event.target.closest(".cancel-btn");
      if (!btn) return;

      try {
        if (!contract) return alert("Connetti prima MetaMask!");
        const id = btn.getAttribute("data-id");
        if (!id) return;

        const conferma = confirm(`Vuoi davvero cancellare la prenotazione #${id}?`);
        if (!conferma) return;

        setStatus(`‚è≥ Cancellazione prenotazione #${id}...`);
        const tx = await contract.cancelBooking(id);
        await tx.wait();

        setStatus(`‚úÖ Prenotazione #${id} cancellata con successo.`, "success");
        myBookingsButton.click(); // ricarica lista
      } catch (err) {
        console.error(err);
        setStatus("Errore nella cancellazione: " + (err.info?.error?.message || err.message || err), "error");
      }
    };
  </script>
</body>
</html>

